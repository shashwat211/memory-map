<!DOCTYPE html>
<html>
<head>
    <title>Shashwat's World Tour üåé</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Fredoka+One&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; overflow: hidden; background: #000; }
        
        #map-background { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }

        /* --- OVERLAYS --- */
        .overlay-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            gap: 20px;
        }

        #end-overlay, #video-intro-overlay { display: none; }

        /* INTRO VIDEO PLAYER */
        #video-intro-overlay {
            background: #000; /* Cinema Mode */
            z-index: 3000;
        }
        
        #intro-video-element {
            width: 100%; max-width: 800px; max-height: 80vh;
            border-radius: 20px; box-shadow: 0 0 50px rgba(108, 92, 231, 0.3);
        }

        .intro-label {
            color: white; font-family: 'Fredoka One'; font-size: 1.5rem; margin-top: 15px;
            animation: fadeIn 1s;
        }

        .skip-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.2); color: white;
            border: 1px solid white; padding: 10px 20px; border-radius: 30px;
            cursor: pointer; z-index: 3001; font-size: 0.9rem;
        }

        /* START SCREEN */
        .big-title {
            color: white; font-family: 'Fredoka One'; font-size: 2.5rem; 
            text-shadow: 0 5px 15px rgba(0,0,0,0.5); text-align: center;
            line-height: 1.2; padding: 0 10px;
        }

        .mode-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white; padding: 18px 30px; border-radius: 50px;
            font-family: 'Fredoka One', cursive; font-size: 1.2rem;
            border: none; cursor: pointer; width: 85%; max-width: 320px;
            box-shadow: 0 10px 25px rgba(108, 92, 231, 0.5);
            transition: transform 0.2s;
        }
        .mode-btn:hover { transform: scale(1.05); background: white; color: #6c5ce7; }
        .mode-btn.secondary { background: #fdcb6e; color: #d35400; box-shadow: 0 10px 25px rgba(253, 203, 110, 0.4); }

        /* --- CARD DESIGN --- */
        #story-card-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; max-width: 450px;
            z-index: 1000;
            display: none; 
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            border: 2px solid rgba(255,255,255,1);
            text-align: center;
            max-height: 80vh; 
            overflow-y: auto;
            position: relative;
            scroll-behavior: smooth; 
        }
        .glass-card::-webkit-scrollbar { width: 0px; background: transparent; }

        .close-btn {
            position: absolute; top: 15px; right: 20px;
            font-size: 1.8rem; color: #b2bec3; cursor: pointer;
            z-index: 10;
        }

        .chapter-title {
            font-family: 'Fredoka One', cursive; color: #6c5ce7;
            font-size: 1.4rem; margin-bottom: 15px; text-transform: uppercase;
        }

        /* --- MEDIA BOX --- */
        .media-box {
            width: 100%; height: 280px; 
            background: #fff; border-radius: 18px;
            overflow: hidden; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 4px solid white;
        }
        .evidence-media { width: 100%; height: 100%; display: block; }
        video.evidence-media { object-fit: cover; }

        .quote-box {
            background: #f4f7f6; padding: 15px; border-radius: 15px;
            font-size: 0.95rem; color: #2d3436; font-style: italic; line-height: 1.6;
            border-left: 5px solid #fab1a0; margin-bottom: 10px; text-align: left; 
        }
        
        .author-tag {
            display: block; text-align: right; font-weight: 800; 
            color: #fab1a0; font-size: 0.85rem; text-transform: uppercase; 
            margin-bottom: 20px; letter-spacing: 1px;
        }

        .action-btn {
            background: #2d3436; color: white; border: none;
            padding: 15px 30px; border-radius: 12px;
            font-weight: 700; font-size: 1rem; cursor: pointer;
            width: 100%; margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .conclusion-wrapper {
            display: none; margin-top: 20px;
            background: linear-gradient(135deg, #fff0f0 0%, #ffeaa7 100%);
            padding: 20px; border-radius: 20px;
            animation: fadeIn 0.8s;
        }
        .verdict-emoji { font-size: 3rem; display: block; margin-bottom: 5px; }
        .verdict-label { font-family: 'Fredoka One'; color: #6c5ce7; font-size: 1.3rem; }

        /* --- MAP PINS --- */
        .custom-pin {
            background: #fff; border: 3px solid #6c5ce7; border-radius: 50%;
            text-align: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex !important; justify-content: center; align-items: center;
            transition: transform 0.2s;
            font-size: 1.2rem; line-height: 1;
        }
        
        .location-label {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #6c5ce7; color: #2d3436;
            font-family: 'Fredoka One', cursive; font-size: 13px;
            padding: 8px 15px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .leaflet-tooltip { background: transparent; border: none; box-shadow: none; }
        .leaflet-tooltip-left:before, .leaflet-tooltip-right:before { border: none !important; }

    </style>
</head>
<body>

    <div id="start-overlay" class="overlay-screen">
        <h1 class="big-title">Shashwat's<br>World Tour üåé</h1>
        <button class="mode-btn" onclick="initiateJourney(false)">üïπÔ∏è Manual Explore</button>
        <button class="mode-btn secondary" onclick="initiateJourney(true)">üçø Watch Movie</button>
        <p style="color:rgba(255,255,255,0.7); margin-top:10px; font-size:0.9rem;">(Turn on sound! üîä)</p>
    </div>

    <div id="video-intro-overlay" class="overlay-screen">
        <button class="skip-btn" onclick="endIntroSequence()">Skip Intro ‚è©</button>
        
        <video id="intro-video-element" playsinline webkit-playsinline controls></video>
        <div id="intro-text" class="intro-label"></div>
    </div>

    <div id="end-overlay" class="overlay-screen">
        <h1 class="big-title" style="color:#fdcb6e;">Happy Birthday<br>Shashwat! üéÇ</h1>
        <div style="font-size: 4rem; animation: bounce 2s infinite;">üéÅ</div>
        <button class="mode-btn" onclick="location.reload()">üîÑ Replay Journey</button>
    </div>

    <div id="map-background"></div>

    <div id="story-card-container">
        <div class="glass-card animate__animated animate__zoomIn">
            
            <div class="close-btn" onclick="closeCard()">&times;</div>
            <div id="chapter-title" class="chapter-title">Title</div>

            <div class="media-box">
                <img id="ev-img" class="evidence-media" src="" style="display:none;">
                <video id="ev-video" class="evidence-media" src="" controls playsinline webkit-playsinline style="display:none;"></video>
            </div>
            
            <div class="quote-box" id="ev-text"></div>
            <span class="author-tag" id="ev-author"></span>

            <button id="reveal-btn" class="action-btn" onclick="revealConclusion()">üéÅ Open Gift</button>

            <div id="conclusion-wrapper" class="conclusion-wrapper">
                <p id="conc-narrative" style="font-weight: 600; color: #444; margin-bottom:15px; font-size:1.1rem; line-height:1.4;"></p>
                
                <div style="background: white; padding: 15px; border-radius: 15px; transform: rotate(-1deg); margin-bottom: 20px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                    <span class="verdict-emoji" id="conc-icon"></span>
                    <span class="verdict-label" id="conc-title"></span>
                </div>

                <button id="next-btn" class="action-btn" style="background:#6c5ce7;" onclick="nextStory()">Next Memory ‚û°Ô∏è</button>
            </div>

        </div>
    </div>

    <script>
        // --- 0. OPENING VIDEOS CONFIG ---
        const openingVideos = [
            { src: "Images/birthday_song.mp4", label: "üéÇ A special song from Sister..." },
            { src: "Images/maa_papa.mp4", label: "‚ù§Ô∏è Messages from Mom & Dad" },
            { src: "Images/papa.mp4", label: "üë® Message from Father" },
            { src: "Images/jiju.mp4", label: "Our own PCM" },
            { src: "Images/watermelon.mp4", label: "Our watermelon" }

            
        ];

        // --- 1. DATASET ---
        const storyline = [
            {
                chapter: "The Sole Protector",
                location: "üìç Munich Beach",
                lat: 48.1319, lng: 11.6019, 
                img: "Images/aditi.jpeg", fit: "cover", pos: "center",
                text: "I have so many fond memories with Shashwat, but one of my favourites stands out clearly. There was a birthday party on the beach, and I reached quite late. Everyone had brought something special, and by the time I arrived, I was extremely hungry. When Shashwat noticed me quietly looking around for food, he immediately came running and started making a plate just for me. He stayed by my side, making sure I ate properly and felt comfortable, not leaving until I was completely fed and felt good. That moment‚Äîhis kindness, and thoughtfulness‚Äîtruly touched my heart.",
                author: "Aditi",
                narrative: "He cushions the hard impact of life and supports your sole. He isn't a flashy high-heel that hurts you, he is...",
                icon: "üëü", title: "Comfy Sneakers"
            },
            {
                chapter: "The Harmonizer",
                location: "üìç Porto, Portugal",
                lat: 41.1579, lng: -8.6291,
                img: "Images/vinit.jpeg", fit: "contain",
                text: "The specific memory with Shashwat is from Porto when we were parking the car and there was no space üòÇ",
                author: "Vinit",
                narrative: "When the world is screaming and chaotic, he doesn't toot his own horn. He just brings the sweet melody.",
                icon: "ü™à", title: "A Flute"
            },
            {
                chapter: "The Unpaid Intern",
                location: "üìç Vienna, Austria",
                lat: 48.2082, lng: 16.3738,
                img: "Images/diksha.jpeg", fit: "cover", pos: "center 20%",
                text: "I have memories with him in few countries by now but in Austria and Germany (munich) one are my favourite. Because in both places we have home ‚ù§Ô∏è. This photo summerises one of the day 15th sep 2023, i was so drunk to remember anything. He made sure that I reach home safe, I drink enough. Its just one of them, he has forever been like my younger brother, I know whom I can rely on. Be it my wedding, my birthday, with taking care of my sister, with introducing me best people. He has been a blessing to me ‚ù§Ô∏è",
                author: "Diksha",
                narrative: "He works tirelessly for the betterment of society (us) without getting paid. If he wasn't an engineer, he'd be broke but happy as a...",
                icon: "ü§ù", title: "Social Worker"
            },
            {
                chapter: "The Texture Paradox",
                location: "üìç Innsbruck, Austria",
                lat: 47.2692, lng: 11.4041,
                img: "Images/meghna.jpeg", fit: "cover", pos: "center 70%",
                text: "Innsbruck where it was a double date (me, Krishnan, you & Shashwat), only that you & Shashwat didn't know it yet‚ù§Ô∏è",
                author: "Meghna",
                narrative: "He is a man of contradictions. In texts? He ghosts you (Tissue Paper - flaky). In person? He keeps you warm (Decathlon Fleece - quality).",
                icon: "üß•", title: "Fleece & Tissue"
            },
            {
                chapter: "The Ink Flow",
                location: "üìç Reykjavik, Iceland",
                lat: 64.1466, lng: -21.9426,
                img: "Images/srajit.jpeg", fit: "cover", pos: "top center",
                text: "Making memories from Iceland to Portugal.",
                author: "Srajit",
                narrative: "He flows smoothly, he never leaks secrets, and he leaves a permanent mark wherever he goes.",
                icon: "üñäÔ∏è", title: "Gel Pen"
            },
            {
                chapter: "The Ladies' Man",
                location: "üìç IIT Patna",
                lat: 25.5358, lng: 84.8511,
                img: "Images/shreya.jpeg", fit: "cover", pos: "top center",
                text: "Our group spent days and night using this office space in the admin building, treating this as our party place, playing cards and ordering shakes and burgers from Batido, watching movies and having sleepovers. Courtesy of our TPC officer Shashwat MahajanüòÇ",
                author: "Shreya",
                narrative: "High prestige. High demand. And somehow, always surrounded by ladies. He is basically...",
                icon: "üéì", title: "Delhi University"
            },
            {
                chapter: "The Clarity",
                location: "üìç London, UK",
                lat: 51.5074, lng: -0.1278,
                img: "Images/disha.jpeg", fit: "cover", pos: "top center",
                text: "Instead of being younger, he felt like an older brother who cares for me a lot.",
                author: "Disha",
                narrative: "When there is drama or dirt on the windshield of life, one spray of Shashwat wipes it all away. No streaks left behind.",
                icon: "üßº", title: "Glass Cleaner"
            },
            {
                chapter: "The Reliable Ride",
                location: "üìç Santa Cruz, USA",
                lat: 36.9741, lng: -122.0308,
                img: "Images/yun.jpeg", fit: "cover", pos: "top center",
                text: "I love our Santa Cruz bonfire! Such a good memory.",
                author: "Yun",
                narrative: "High mileage friendship. Low maintenance. And an engine that never quits (just don't ask him to speed).",
                icon: "üöó", title: "A Toyota"
            },
            {
                chapter: "The Ghost",
                location: "üìç Khada Danda",
                lat: 25.6155, lng: 85.1355,
                img: "Images/hrisabh.jpeg", video: "Images/hrisabh.mp4",
                text: "We have great memories on Khada Danda road, but trying to reach him afterwards is another story...",
                author: "Hrishab",
                narrative: "You speak to him, but he doesn't speak back until 3 months later. He effectively functions as a vintage...",
                icon: "üì±", title: "Voicemail"
            },
            {
                chapter: "The Spotlight",
                location: "üìç Kerala, India",
                lat: 9.9312, lng: 76.2673,
                img: "Images/saurabh.jpeg", fit: "contain",
                text: "Using a 'Nada' to tie his shorts... he unintentionally becomes the highlight of the trip.",
                author: "Sourabh",
                narrative: "Unlike sunflower that follows light, its him that light follows.",
                icon: "üåª", title: "Reverse Sunflower"
            },
            {
                chapter: "The Softie",
                location: "üìç Hallstatt, Austria",
                lat: 47.5622, lng: 13.6493,
                img: "Images/Ann.jpeg", fit: "contain",
                text: "Thanks for organising such a nice trip. It was smooth sailing.",
                author: "Ann",
                narrative: "He has no crunch, no hard shell, and no nuts (metaphorically). Just pure, soft sweetness.",
                icon: "üç´", title: "Milkyway Bar"
            },
            {
                chapter: "The Natural",
                location: "üìç Munich, Germany",
                lat: 48.1495, lng: 11.5780,
                img: "Images/nikita.jpeg", fit: "contain",
                text: "Munich: His house, his cooking, my appetite.",
                author: "Nikita",
                narrative: "He isn't neon or flashing lights. He is the color of grounding, cooking, and nature.",
                icon: "üå≤", title: "Forest Green"
            },
            {
                chapter: "The Protagonist",
                location: "üìç Marienplatz",
                lat: 48.1374, lng: 11.5755,
                img: "Images/krishnan.jpeg", fit: "contain",
                text: "Trespassing into a closed restaurant just to play in the kids' area.",
                author: "Krishnan",
                narrative: "He doesn't need to act. One day, Hollywood will make a biopic about how nice (and crazy) he is.",
                icon: "üé¨", title: "Movie Character"
            },
            {
                chapter: "The Electric Hug",
                location: "üìç Strasbourg",
                lat: 48.5734, lng: 7.7521,
                img: "Images/nancy.jpeg", fit: "contain",
                text: "Strassburg and the starry nights with you.",
                author: "Nancy",
                narrative: "He is shocking...ly cute. No batteries required for his warmth.",
                icon: "üêº", title: "No-Battery Panda"
            },
            {
                chapter: "The Breeze",
                location: "üìç Munich Gym",
                lat: 48.1439, lng: 11.5475,
                img: "Images/kara.jpeg", fit: "contain",
                text: "In the fitness studio when we learnt dancing.",
                author: "Kara",
                narrative: "You can't catch him, you can't hold him, but when he passes by, everything feels pleasant.",
                icon: "üçÉ", title: "September Wind"
            },
            {
                chapter: "The Foundation",
                location: "üìç Munich Home",
                lat: 48.1492, lng: 11.5774,
                img: "Images/shivani.jpeg", fit: "contain",
                text: "Best memory I can‚Äôt really define we always had a good time but what I really adore about him is: He‚Äôs one of the kindest person I know and most accommodating one. He always made sure I never felt out of place whenever he was around",
                author: "Shivani",
                narrative: "He isn't a flashy skyscraper. He is the concrete foundation that makes everyone else feel safe.",
                icon: "‚ù§Ô∏è", title: "Home Base"
            },
            {
                chapter: "The Survivor",
                location: "üìç Mittenwald",
                lat: 47.4430, lng: 11.2655,
                img: "Images/shejal.jpeg", fit: "contain",
                text: "What an amazing hike or should I say, a cooking trip in the mountains on a work day! We carried laptops to work and our chatori asses carried rajma chawal, gas stove(yes we did!), maggi, and sandwiches‚Ä¶ and guess what? Not a single laptop was used. The gas stove didn‚Äôt work. So we lit a fire in the forest with grass and sticks, and I had the best warmest rajma of my life in the mountains. Shashwat you turned a boring workday into an unforgettable lit memory. Happiest birthday boi! Keep spreading your warmth.",
                author: "Shejal",
                narrative: "Deutsche bahn - always late but runs fast xD",
                icon: "üöÜ", title: "Public Transport"
            },
            {
                chapter: "The Family",
                location: "üìç Nederlinger str",
                lat: 48.1650, lng: 11.5300,
                img: "Images/Akash.jpeg", fit: "contain",
                text: "I had just come to Munich and I found this lovely group of friends I called home. This picture is a testament to this emotion. At the same time its a bitter sweet emotion, as we do not / cannot have this again. In Shashwat, I found a friend who is always there for you when you need him (no questions asked, seriously!). Wish you a very happy birthday Shashwat!",
                author: "Akash",
                narrative: "Refreshing and sweet.",
                icon: "üçã", title: "Lemonade"
            },
            {
                chapter: "The Spark",
                location: "üìç IIT Patna Fest",
                lat: 25.5350, lng: 84.8520,
                img: "Images/Aryan.jpeg", fit: "contain",
                text: "This is from our first reverb ( college diwali fest )",
                author: "Aryan",
                narrative: "He lights up the night.",
                icon: "üéÜ", title: "Firecracker"
            },
            {
                chapter: "The Coder",
                location: "üìç IIT Roorkee",
                lat: 29.8649, lng: 77.8966,
                img: "Images/Joshika.jpeg", fit: "contain",
                text: "This Roorkee inter-IIT trip photo brings back so many memories of laughs, sleepless 24 hrs of CTF with us desperately trying to solve 2 problemsüòÇ, and good times that still make me smile. So grateful for you and for everything we've shared. Happy Birthday ‚ù§Ô∏è",
                author: "Joshika",
                narrative: "Logic, determination, and late nights.",
                icon: "üíª", title: "Debugged Code"
            },
            {
                chapter: "The Cool",
                location: "üìç IIT P Jungle",
                lat: 25.5320, lng: 84.8480,
                img: "Images/bhumika2.jpeg", fit: "contain",
                text: "IIT Patna restricted jungle area",
                author: "Bhumika",
                narrative: "If Shashwat were a state of water, he would be 'baraf wali icecream'",
                icon: "üçß", title: "Ice Cream"
            },
            {
                chapter: "The Director",
                location: "üìç IIT Patna",
                lat: 25.5340, lng: 84.8500,
                img: "Images/Balbeer.jpeg", fit: "contain",
                text: "Always creating the best scenes and memories!",
                author: "Balbeer",
                narrative: "If he was a celebrity, he will definitely be Karan Johar",
                icon: "üé•", title: "Karan Johar"
            },
            {
                chapter: "The Agent",
                location: "üìç London Eye",
                lat: 51.5033, lng: -0.1195,
                img: "Images/AkhileshLihe.mp4",
                text: "Wishing you a fantastic year ahead from London!",
                author: "Akhilesh & Lihe",
                narrative: "Supportive agent listen first and response after",
                icon: "ü§ñ", title: "AI Agent"
            },
            {
                chapter: "The Style",
                location: "üìç Marienplatz",
                lat: 48.1380, lng: 11.5760,
                img: "Images/Alex.jpeg", fit: "contain",
                text: "Here's to more food adventures and great style!",
                author: "Alexandra",
                narrative: "Ankle lenth shoes",
                icon: "üëü", title: "Trendy Shoe"
            },
            {
                chapter: "The Strength",
                location: "üìç Switzerland",
                lat: 46.8182, lng: 8.2275,
                img: "Images/Dikshant.jpeg", fit: "contain",
                text: "Reaching new heights together!",
                author: "Dikshant",
                narrative: "pull up assistance band",
                icon: "üí™", title: "Gym Equipment"
            },
           {
                chapter: "The Saviour",
                location: "üìç Himachal",
                lat: 32.2432, lng: 77.1892,
                img: "Images/cooking_shashu.jpeg", fit: "contain",
                text: "Ye hamari ek memory h jab vo mere saath badag mai aaya tha hamari gas khatam ho gayi thi. To hamne turpentine oil stove par khana banaya tha. Exactly 1 year ago.Aur 90 percent khana issi ne banaya tha",
                author: "Sister",
                narrative: "Chef under pressure, literally.",
                icon: "ü•ò", title: "Master Chef"
            },
            {
                chapter: "The Big Brother",
                location: "üìç IIT Patna",
                lat: 25.5357, lng: 84.8512,
                img: "Images/tarusi.mp4", fit: "contain",
                text: "And then jab hum college main the toh last last days main faculty quarters main swings hote the. Toh mujhe jaana hota tha swings lene but main humesha yeh bolti thi ki bhaiya ka man hai toh isliye jaare. And ismain bhi end main merese yehi pucha jaara hai ki maine kya padhayi kari üò©",
                author: "Tarusi",
                narrative: "A soft toy i think he will be a penguin because they are goofy, loving and there for each other",
                icon: "üêß", title: "Soft Toy"
            },
            {
                chapter: "The Stylist",
                location: "üìç Train, Germany",
                lat: 49.4521, lng: 11.0767,
                img: "Images/aanchal.jpeg", fit: "contain",
                text: "One of my favorite memories with Shashwat is when we braided each other's hair. I gave him a french braid and I was amazed at how good it looked at him. I was also very glad that he liked it enough to keep it as is until the next day. He also learnt how to braid from me and practiced on my hair.",
                author: "Aanchal",
                narrative: "basil is a symbol of warmth and hospitality",
                icon: "üåø", title: "Basil"
            },
        
        ];

        // --- 2. MAP & MARKERS ---
        var map = L.map('map-background', {
            zoomControl: false, scrollWheelZoom: true, dragging: true
        }).setView([30, 10], 3);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '', maxZoom: 19
        }).addTo(map);

        let currentActiveIndex = 0;
        let isAutoplay = false;
        let mapMarkers = []; 

        storyline.forEach((data, index) => {
            const smallIcon = L.divIcon({
                className: 'custom-pin',
                html: `<span>${data.icon}</span>`, 
                iconSize: [42, 42],
                iconAnchor: [21, 21]
            });

            const marker = L.marker([data.lat, data.lng], {icon: smallIcon}).addTo(map);
            
            marker.bindTooltip(data.location, { 
                direction: 'top', 
                offset: [0, -10],
                className: 'location-label',
                permanent: false 
            });

            marker.on('click', () => {
                if(!isAutoplay) {
                    currentActiveIndex = index;
                    openStory(index);
                }
            });
            
            mapMarkers.push(marker);
        });

        // --- 3. VIDEO INTRO LOGIC ---
        
        let introIndex = 0;

        function initiateJourney(autoplayMode) {
            isAutoplay = autoplayMode;
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('video-intro-overlay').style.display = 'flex';
            
            playNextIntroVideo();
        }

        function playNextIntroVideo() {
            if(introIndex >= openingVideos.length) {
                endIntroSequence();
                return;
            }

            const videoData = openingVideos[introIndex];
            const videoEl = document.getElementById('intro-video-element');
            const textEl = document.getElementById('intro-text');

            videoEl.src = videoData.src;
            textEl.innerText = videoData.label;
            
            videoEl.play().catch(e => {
                console.log("Auto-play prevented, waiting for interaction or skip");
            });

            videoEl.onended = () => {
                introIndex++;
                playNextIntroVideo();
            };
        }

        function endIntroSequence() {
            document.getElementById('video-intro-overlay').style.display = 'none';
            document.getElementById('intro-video-element').pause(); // Stop if skipped
            
            // START THE MAP JOURNEY
            if(isAutoplay) {
                startAutoplay();
            } else {
                startManual();
            }
        }

        // --- 4. MAP JOURNEY LOGIC ---

        function startManual() {
            // Manual mode: just reset index and let user click or we fly to first
            // Optional: Fly to first location to help them start
            openStory(0);
        }

        function startAutoplay() {
            document.getElementById('reveal-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.querySelector('.close-btn').style.display = 'none';
            runAutoplaySequence(0);
        }

        function runAutoplaySequence(index) {
            if(index >= storyline.length) {
                finishTour(); 
                return;
            }

            // Step 1: Fly to Location
            openStory(index);

            // Step 2: Wait 3.5s (Travel time) -> Show Card
            setTimeout(() => {
                const cardContainer = document.getElementById('story-card-container');
                const card = document.querySelector('.glass-card');
                const vid = document.getElementById('ev-video');

                cardContainer.style.display = 'block';
                card.scrollTop = 0;

                const currentStory = storyline[index];
                const isVideo = currentStory.video || (currentStory.img && currentStory.img.endsWith('.mp4'));

                if(isVideo) {
                    const safetyTimer = setTimeout(() => {
                        performScrollAndReveal(currentStory);
                    }, 8000); 

                    vid.currentTime = 0;
                    var playPromise = vid.play();

                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            clearTimeout(safetyTimer);
                            const durationSafe = (vid.duration && !isNaN(vid.duration)) ? (vid.duration * 1000) + 1000 : 8000;
                            const longTimer = setTimeout(() => {
                                performScrollAndReveal(currentStory);
                            }, durationSafe);

                            vid.onended = () => {
                                clearTimeout(longTimer);
                                performScrollAndReveal(currentStory);
                            };
                        })
                        .catch(error => {
                            clearTimeout(safetyTimer);
                            setTimeout(() => {
                                performScrollAndReveal(currentStory);
                            }, 3000);
                        });
                    }
                } else {
                    setTimeout(() => {
                        performScrollAndReveal(currentStory);
                    }, 3000);
                }

                function performScrollAndReveal(storyData) {
                    vid.onended = null; 
                    card.scrollTo({ top: 350, behavior: 'smooth' });

                    const wordCount = storyData.text.split(" ").length;
                    const readingDelay = Math.max(5000, wordCount * 300);

                    setTimeout(() => {
                        revealConclusion();
                        setTimeout(() => {
                            cardContainer.style.display = 'none';
                            if(mapMarkers[index]) mapMarkers[index].closeTooltip();
                            runAutoplaySequence(index + 1);
                        }, 5000);
                    }, readingDelay); 
                }

            }, 3500); 
        }

        function finishTour() {
            document.getElementById('story-card-container').style.display = 'none';
            const endOverlay = document.getElementById('end-overlay');
            endOverlay.style.display = 'flex';
            endOverlay.classList.add('animate__animated', 'animate__fadeIn');
            map.flyTo([30, 10], 2, { duration: 3 });

            var duration = 5 * 1000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60, spread: 55, origin: { x: 0 },
                    colors: ['#6c5ce7', '#fab1a0', '#ffeaa7', '#fdcb6e']
                });
                confetti({
                    particleCount: 5,
                    angle: 120, spread: 55, origin: { x: 1 },
                    colors: ['#6c5ce7', '#fab1a0', '#ffeaa7', '#fdcb6e']
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        function openStory(index) {
            const data = storyline[index];
            currentActiveIndex = index;
            document.getElementById('story-card-container').style.display = 'none';
            map.flyTo([data.lat, data.lng], 10, { duration: 2.0 });

            mapMarkers.forEach(m => m.closeTooltip());
            setTimeout(() => {
                if(mapMarkers[index]) mapMarkers[index].openTooltip();
            }, 1000);

            const revealBtn = document.getElementById('reveal-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if(!isAutoplay) {
                revealBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            } else {
                revealBtn.style.display = 'none';
                nextBtn.style.display = 'none';
            }
            
            document.getElementById('conclusion-wrapper').style.display = 'none';
            document.getElementById('chapter-title').innerText = data.chapter;
            document.getElementById('ev-text').innerText = `"${data.text}"`;
            document.getElementById('ev-author').innerText = `‚Äî ${data.author}`;
            
            const img = document.getElementById('ev-img');
            const vid = document.getElementById('ev-video');
            img.style.objectFit = data.fit || 'contain';
            img.style.objectPosition = data.pos || 'center';

            if(data.video || (data.img && data.img.endsWith('.mp4'))) {
                img.style.display = 'none'; vid.style.display = 'block';
                vid.src = data.video || data.img;
            } else {
                vid.style.display = 'none'; img.style.display = 'block';
                img.src = data.img;
            }

            document.getElementById('conc-narrative').innerText = data.narrative;
            document.getElementById('conc-icon').innerText = data.icon;
            document.getElementById('conc-title').innerText = data.title;

            if(!isAutoplay) {
                setTimeout(() => {
                    document.getElementById('story-card-container').style.display = 'block';
                    document.querySelector('.glass-card').scrollTop = 0;
                }, 3000); 
            }
        }

        function revealConclusion() {
            if(!isAutoplay) document.getElementById('reveal-btn').style.display = 'none';
            const wrapper = document.getElementById('conclusion-wrapper');
            wrapper.style.display = 'block';
            
            setTimeout(() => {
                 document.querySelector('.glass-card').scrollTo({ 
                     top: document.querySelector('.glass-card').scrollHeight, 
                     behavior: 'smooth' 
                 });
            }, 100);

            var duration = 2 * 1000;
            var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#6c5ce7', '#fab1a0', '#ffeaa7'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#6c5ce7', '#fab1a0', '#ffeaa7'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        function nextStory() {
            if(mapMarkers[currentActiveIndex]) mapMarkers[currentActiveIndex].closeTooltip();
            
            let nextIndex = currentActiveIndex + 1;
            if(nextIndex >= storyline.length) {
                finishTour(); 
                return;
            }
            openStory(nextIndex);
        }

        function closeCard() {
            document.getElementById('story-card-container').style.display = 'none';
            if(mapMarkers[currentActiveIndex]) mapMarkers[currentActiveIndex].closeTooltip();
        }

    </script>
</body>
</html>